<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace = "com.somebody.db.MapperUone">

	<insert id = "is" parameterType = "beans.Centers">
		insert into kmasters.ct (CTCODE,CTNAME,CTADDRESS,CTCEO,CTNUMBER) values(#{ctCode},'1','1','1','1') 
	</insert>
	
	<select id = "meDtInfo" resultType = "beans.Members" parameterType = "beans.Members">
		SELECT  DISTINCT ME.MENAME AS meName,
        (SELECT NVL(TRUNC(MONTHS_BETWEEN(SYSDATE, TO_DATE(SUBSTR(TO_CHAR(MEBIRTH,'YYYY'),1,4),'YYYY'))/12), 0)+1 FROM KMASTERS.ME WHERE MECODE = #{meCode}) AS meBirth,
        ME.MEEMAIL AS meEmail,
        ME.MENUMBER AS meNumber,
        (SELECT CA.CANAME FROM KMASTERS.CA WHERE CA.CACODE = ME.MEGENDER)AS meGender,
        (SELECT SUM(PATOTAL) FROM KMASTERS.PA WHERE PAMECODE=#{meCode} AND PALPCTCODE =#{ctCode} ) AS paTotal,
        (SELECT SUBSTR(TO_CHAR(MAX(PADATE),'YYYYMMDD'),1,8) FROM KMASTERS.PA WHERE PAMECODE = #{meCode}) AS paDate,
        (SELECT DISTINCT SF.SFNAME FROM KMASTERS.SF WHERE LS.LSCACODE = 'L1' AND PA.PAMECODE = #{meCode} AND SF.SFCTCODE =#{ctCode} 
        AND SF.SFCODE = (SELECT DISTINCT RELSSFCODE AS sfCode
            FROM KMASTERS.SF
            WHERE RE.RELSCTCODE = #{ctCode} AND LS.LSSFCODE = RE.RELSSFCODE AND RE.REMECODE =#{meCode} )) AS sfName,
        (SELECT EQ.EQNAME FROM KMASTERS.EQ WHERE EQ.EQCODE = (SELECT LG.LGEQCODE FROM KMASTERS.LG WHERE LG.LGMECODE = ME.MECODE)) AS locker,
        
        (SELECT REGEXP_REPLACE(LISTAGG(CAST(CA.CANAME AS VARCHAR(50)),',') WITHIN GROUP (ORDER BY CA.CANAME),'([^,]+)(,\1)+', '\1') AS lsName
        FROM KMASTERS.CA INNER JOIN KMASTERS.PA ON CA.CACODE =PA.PALPCACODE WHERE PA.PAMECODE=#{meCode} AND PALPCTCODE = #{ctCode})  AS lsName

		FROM KMASTERS.ME INNER JOIN KMASTERS.PA ON ME.MECODE = PA.PAMECODE
        	INNER JOIN KMASTERS.CA ON PA.PALPCACODE = CA.CACODE
       		INNER JOIN KMASTERS.SF ON PA.PALPCTCODE = SF.SFCTCODE
       		INNER JOIN KMASTERS.LG ON ME.MECODE = LG.LGMECODE
       		INNER JOIN KMASTERS.EQ ON LG.LGEQCODE = EQ.EQCODE
       		INNER JOIN KMASTERS.LS ON EQ.EQCTCODE = LS.LSSFCTCODE 
       		INNER JOIN KMASTERS.MG ON MG.MGCTCODE = PA.PALPCTCODE
       		INNER JOIN KMASTERS.RE ON ME.MECODE = RE.REMECODE
			WHERE ME.MECODE = #{meCode} AND LS.LSSFCODE = RE.RELSSFCODE
	</select>
		
	<select id = "meInbodyMg" resultType = "beans.Inbodys" parameterType = "beans.Inbodys">
	SELECT IDCOUNT AS idCount,
        DAUNIT AS daUnit,
        DANAME AS daName,
        SUBSTR(IDIBCODE,6,14) AS ibDate
	FROM KMASTERS.ID INNER JOIN KMASTERS.DA ON IDDACODE = DACODE
	WHERE IDIBCODE = (SELECT MAX(IDIBCODE) FROM KMASTERS.ID WHERE SUBSTR(IDIBCODE,1,5) = #{meCode}) ORDER BY DANAME
	</select>
	
	<update id="delMe" parameterType ="beans.Members">
		UPDATE KMASTERS.ME SET MEBIRTH = (SELECT SYSDATE FROM DUAL) , MEEMAIL = 'DELETE',MENAME ='DELETE',MENUMBER='DELETE',MEPASSWORD='DELETE' WHERE MECODE =#{meCode}
	</update>
	
	<update id="modMeMg" parameterType = "beans.Members">
		UPDATE KMASTERS.ME SET MEBIRTH = #{meBirth} , MENAME = #{meName} , MENUMBER = #{meNumber} WHERE MECODE = #{meCode}
	</update>

</mapper>